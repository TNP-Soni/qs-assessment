import { EventEmitter, Inject, Injectable, Optional, PLATFORM_ID } from '@angular/core';
import { Interrupt } from './interrupt';
import { LocalStorageExpiry } from './localstorageexpiry';
import * as i0 from "@angular/core";
import * as i1 from "./idleexpiry";
import * as i2 from "./keepalivesvc";
/*
 * Indicates the desired auto resume behavior.
 */
export var AutoResume;
(function (AutoResume) {
    /*
     * Auto resume functionality will be disabled.
     */
    AutoResume[AutoResume["disabled"] = 0] = "disabled";
    /*
     * Can resume automatically even if they are idle.
     */
    AutoResume[AutoResume["idle"] = 1] = "idle";
    /*
     * Can only resume automatically if they are not yet idle.
     */
    AutoResume[AutoResume["notIdle"] = 2] = "notIdle";
})(AutoResume || (AutoResume = {}));
/**
 * A service for detecting and responding to user idleness.
 */
export class Idle {
    constructor(expiry, zone, keepaliveSvc, platformId) {
        this.expiry = expiry;
        this.zone = zone;
        this.platformId = platformId;
        this.idle = 20 * 60; // in seconds
        this.timeoutVal = 30; // in seconds
        this.autoResume = AutoResume.idle;
        this.interrupts = new Array();
        this.running = false;
        this.keepaliveEnabled = false;
        this.onIdleStart = new EventEmitter();
        this.onIdleEnd = new EventEmitter();
        this.onTimeoutWarning = new EventEmitter();
        this.onTimeout = new EventEmitter();
        this.onInterrupt = new EventEmitter();
        if (keepaliveSvc) {
            this.keepaliveSvc = keepaliveSvc;
            this.keepaliveEnabled = true;
        }
        this.setIdling(false);
    }
    /*
     * Sets the idle name for localStorage.
     * Important to set if multiple instances of Idle with LocalStorageExpiry
     * @param The name of the idle.
     */
    setIdleName(key) {
        if (this.expiry instanceof LocalStorageExpiry) {
            this.expiry.setIdleName(key);
        }
        else {
            throw new Error('Cannot set expiry key name because no LocalStorageExpiry has been provided.');
        }
    }
    /*
     * Returns whether or not keepalive integration is enabled.
     * @return True if integration is enabled; otherwise, false.
     */
    getKeepaliveEnabled() {
        return this.keepaliveEnabled;
    }
    /*
     * Sets and returns whether or not keepalive integration is enabled.
     * @param True if the integration is enabled; otherwise, false.
     * @return The current value.
     */
    setKeepaliveEnabled(value) {
        if (!this.keepaliveSvc) {
            throw new Error('Cannot enable keepalive integration because no KeepaliveSvc has been provided.');
        }
        return (this.keepaliveEnabled = value);
    }
    /*
     * Returns the current timeout value.
     * @return The timeout value in seconds.
     */
    getTimeout() {
        return this.timeoutVal;
    }
    /*
     * Sets the timeout value.
     * @param seconds - The timeout value in seconds. 0 or false to disable timeout feature.
     * @return The current value. If disabled, the value will be 0.
     */
    setTimeout(seconds) {
        if (seconds === false) {
            this.timeoutVal = 0;
        }
        else if (typeof seconds === 'number' && seconds >= 0) {
            this.timeoutVal = seconds;
        }
        else {
            throw new Error("'seconds' can only be 'false' or a positive number.");
        }
        return this.timeoutVal;
    }
    /*
     * Returns the current idle value.
     * @return The idle value in seconds.
     */
    getIdle() {
        return this.idle;
    }
    /*
     * Sets the idle value.
     * @param seconds - The idle value in seconds.
     * @return The idle value in seconds.
     */
    setIdle(seconds) {
        if (seconds <= 0) {
            throw new Error("'seconds' must be greater zero");
        }
        return (this.idle = seconds);
    }
    /*
     * Returns the current autoresume value.
     * @return The current value.
     */
    getAutoResume() {
        return this.autoResume;
    }
    setAutoResume(value) {
        return (this.autoResume = value);
    }
    /*
     * Sets interrupts from the specified sources.
     * @param sources - Interrupt sources.
     * @return The resulting interrupts.
     */
    setInterrupts(sources) {
        this.clearInterrupts();
        const self = this;
        for (const source of sources) {
            const options = { platformId: this.platformId };
            const sub = new Interrupt(source, options);
            sub.subscribe((args) => {
                self.interrupt(args.force, args.innerArgs);
            });
            this.interrupts.push(sub);
        }
        return this.interrupts;
    }
    /*
     * Returns the current interrupts.
     * @return The current interrupts.
     */
    getInterrupts() {
        return this.interrupts;
    }
    /*
     * Pauses, unsubscribes, and clears the current interrupt subscriptions.
     */
    clearInterrupts() {
        for (const sub of this.interrupts) {
            sub.pause();
            sub.unsubscribe();
        }
        this.interrupts.length = 0;
    }
    /*
     * Returns whether or not the service is running i.e. watching for idleness.
     * @return True if service is watching; otherwise, false.
     */
    isRunning() {
        return this.running;
    }
    /*
     * Returns whether or not the user is considered idle.
     * @return True if the user is in the idle state; otherwise, false.
     */
    isIdling() {
        return this.idling;
    }
    /*
     * Starts watching for inactivity.
     */
    watch(skipExpiry) {
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        const timeout = !this.timeoutVal ? 0 : this.timeoutVal;
        if (!skipExpiry) {
            const value = new Date(this.expiry.now().getTime() + (this.idle + timeout) * 1000);
            this.expiry.last(value);
        }
        if (this.idling) {
            this.toggleState();
        }
        if (!this.running) {
            this.startKeepalive();
            this.toggleInterrupts(true);
        }
        this.running = true;
        const watchFn = () => {
            this.zone.run(() => {
                const diff = this.getExpiryDiff(timeout);
                if (diff > 0) {
                    this.safeClearInterval('idleHandle');
                    this.setIdleIntervalOutsideOfZone(watchFn, 1000);
                }
                else {
                    this.toggleState();
                }
            });
        };
        this.setIdleIntervalOutsideOfZone(watchFn, 1000);
    }
    /*
     * Allows protractor tests to call waitForAngular without hanging
     */
    setIdleIntervalOutsideOfZone(watchFn, frequency) {
        this.zone.runOutsideAngular(() => {
            this.idleHandle = setInterval(watchFn, frequency);
        });
    }
    /*
     * Stops watching for inactivity.
     */
    stop() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(false);
        this.running = false;
        this.expiry.last(null);
    }
    /*
     * Forces a timeout event and state.
     */
    timeout() {
        this.stopKeepalive();
        this.toggleInterrupts(false);
        this.safeClearInterval('idleHandle');
        this.safeClearInterval('timeoutHandle');
        this.setIdling(true);
        this.running = false;
        this.countdown = 0;
        this.onTimeout.emit(null);
    }
    /*
     * Signals that user activity has occurred.
     * @param force - Forces watch to be called, unless they are timed out.
     * @param eventArgs - Optional source event arguments.
     */
    interrupt(force, eventArgs) {
        if (!this.running) {
            return;
        }
        if (this.timeoutVal && this.expiry.isExpired()) {
            this.timeout();
            return;
        }
        this.onInterrupt.emit(eventArgs);
        if (force === true ||
            this.autoResume === AutoResume.idle ||
            (this.autoResume === AutoResume.notIdle && !this.expiry.idling())) {
            this.watch(force);
        }
    }
    setIdling(value) {
        this.idling = value;
        this.expiry.idling(value);
    }
    toggleState() {
        this.setIdling(!this.idling);
        if (this.idling) {
            this.onIdleStart.emit(null);
            this.stopKeepalive();
            if (this.timeoutVal > 0) {
                this.countdown = this.timeoutVal;
                this.doCountdown();
                this.setTimeoutIntervalOutsideZone(() => {
                    this.doCountdownInZone();
                }, 1000);
            }
        }
        else {
            this.toggleInterrupts(true);
            this.onIdleEnd.emit(null);
            this.startKeepalive();
        }
        this.safeClearInterval('idleHandle');
    }
    setTimeoutIntervalOutsideZone(intervalFn, frequency) {
        this.zone.runOutsideAngular(() => {
            this.timeoutHandle = setInterval(() => {
                intervalFn();
            }, frequency);
        });
    }
    toggleInterrupts(resume) {
        for (const interrupt of this.interrupts) {
            if (resume) {
                interrupt.resume();
            }
            else {
                interrupt.pause();
            }
        }
    }
    getExpiryDiff(timeout) {
        const now = this.expiry.now();
        const last = this.expiry.last() || now;
        return last.getTime() - now.getTime() - timeout * 1000;
    }
    doCountdownInZone() {
        this.zone.run(() => {
            this.doCountdown();
        });
    }
    doCountdown() {
        const diff = this.getExpiryDiff(this.timeoutVal);
        if (diff > 0) {
            this.safeClearInterval('timeoutHandle');
            this.interrupt(true);
            return;
        }
        if (!this.idling) {
            return;
        }
        if (this.countdown <= 0) {
            this.timeout();
            return;
        }
        this.onTimeoutWarning.emit(this.countdown);
        const countdownMs = ((this.timeoutVal - 1) * 1000) + diff;
        this.countdown = Math.round(countdownMs / 1000);
    }
    safeClearInterval(handleName) {
        const handle = this[handleName];
        if (handle !== null && typeof handle !== 'undefined') {
            clearInterval(this[handleName]);
            this[handleName] = null;
        }
    }
    startKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        if (this.running) {
            this.keepaliveSvc.ping();
        }
        this.keepaliveSvc.start();
    }
    stopKeepalive() {
        if (!this.keepaliveSvc || !this.keepaliveEnabled) {
            return;
        }
        this.keepaliveSvc.stop();
    }
    /*
     * Called by Angular when destroying the instance.
     */
    ngOnDestroy() {
        this.stop();
        this.clearInterrupts();
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "18.2.5", ngImport: i0, type: Idle, deps: [{ token: i1.IdleExpiry }, { token: i0.NgZone }, { token: i2.KeepaliveSvc, optional: true }, { token: PLATFORM_ID, optional: true }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "18.2.5", ngImport: i0, type: Idle }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "18.2.5", ngImport: i0, type: Idle, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.IdleExpiry }, { type: i0.NgZone }, { type: i2.KeepaliveSvc, decorators: [{
                    type: Optional
                }] }, { type: Object, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaWRsZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvc3JjL2xpYi9pZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxZQUFZLEVBQ1osTUFBTSxFQUNOLFVBQVUsRUFHVixRQUFRLEVBQ1IsV0FBVyxFQUNaLE1BQU0sZUFBZSxDQUFDO0FBR3ZCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFJeEMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7Ozs7QUFFMUQ7O0dBRUc7QUFDSCxNQUFNLENBQU4sSUFBWSxVQWFYO0FBYkQsV0FBWSxVQUFVO0lBQ3BCOztPQUVHO0lBQ0gsbURBQVEsQ0FBQTtJQUNSOztPQUVHO0lBQ0gsMkNBQUksQ0FBQTtJQUNKOztPQUVHO0lBQ0gsaURBQU8sQ0FBQTtBQUNULENBQUMsRUFiVyxVQUFVLEtBQVYsVUFBVSxRQWFyQjtBQUVEOztHQUVHO0FBRUgsTUFBTSxPQUFPLElBQUk7SUFxQmYsWUFDVSxNQUFrQixFQUNsQixJQUFZLEVBQ1IsWUFBMkIsRUFDRSxVQUFtQjtRQUhwRCxXQUFNLEdBQU4sTUFBTSxDQUFZO1FBQ2xCLFNBQUksR0FBSixJQUFJLENBQVE7UUFFcUIsZUFBVSxHQUFWLFVBQVUsQ0FBUztRQXhCdEQsU0FBSSxHQUFXLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO1FBQ3JDLGVBQVUsR0FBRyxFQUFFLENBQUMsQ0FBQyxhQUFhO1FBQzlCLGVBQVUsR0FBZSxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3pDLGVBQVUsR0FBcUIsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUMzQyxZQUFPLEdBQUcsS0FBSyxDQUFDO1FBS2hCLHFCQUFnQixHQUFHLEtBQUssQ0FBQztRQUcxQixnQkFBVyxHQUFzQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBQ3BELGNBQVMsR0FBc0IsSUFBSSxZQUFZLEVB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LElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQ2hDLElBQUksQ0FBQyxVQUFVLENBQUMsR0FBRyxJQUFJLENBQUM7UUFDMUIsQ0FBQztJQUNILENBQUM7SUFFTyxjQUFjO1FBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDakQsT0FBTztRQUNULENBQUM7UUFFRCxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqQixJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQzNCLENBQUM7UUFFRCxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFTyxhQUFhO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDakQsT0FBTztRQUNULENBQUM7UUFFRCxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVc7UUFDVCxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDWixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7SUFDekIsQ0FBQzs4R0FoYVUsSUFBSSw4R0F5Qk8sV0FBVztrSEF6QnRCLElBQUk7OzJGQUFKLElBQUk7a0JBRGhCLFVBQVU7OzBCQXlCTixRQUFROzswQkFDUixRQUFROzswQkFBSSxNQUFNOzJCQUFDLFdBQVciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdCxcbiAgSW5qZWN0YWJsZSxcbiAgTmdab25lLFxuICBPbkRlc3Ryb3ksXG4gIE9wdGlvbmFsLFxuICBQTEFURk9STV9JRFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgSWRsZUV4cGlyeSB9IGZyb20gJy4vaWRsZWV4cGlyeSc7XG5pbXBvcnQgeyBJbnRlcnJ1cHQgfSBmcm9tICcuL2ludGVycnVwdCc7XG5pbXBvcnQgeyBJbnRlcnJ1cHRBcmdzIH0gZnJvbSAnLi9pbnRlcnJ1cHRhcmdzJztcbmltcG9ydCB7IEludGVycnVwdFNvdXJjZSB9IGZyb20gJy4vaW50ZXJydXB0c291cmNlJztcbmltcG9ydCB7IEtlZXBhbGl2ZVN2YyB9IGZyb20gJy4va2VlcGFsaXZlc3ZjJztcbmltcG9ydCB7IExvY2FsU3RvcmFnZUV4cGlyeSB9IGZyb20gJy4vbG9jYWxzdG9yYWdlZXhwaXJ5JztcblxuLypcbiAqIEluZGljYXRlcyB0aGUgZGVzaXJlZCBhdXRvIHJlc3VtZSBiZWhhdmlvci5cbiAqL1xuZXhwb3J0IGVudW0gQXV0b1Jlc3VtZSB7XG4gIC8qXG4gICAqIEF1dG8gcmVzdW1lIGZ1bmN0aW9uYWxpdHkgd2lsbCBiZSBkaXNhYmxlZC5cbiAgICovXG4gIGRpc2FibGVkLFxuICAvKlxuICAgKiBDYW4gcmVzdW1lIGF1dG9tYXRpY2FsbHkgZXZlbiBpZiB0aGV5IGFyZSBpZGxlLlxuICAgKi9cbiAgaWRsZSxcbiAgLypcbiAgICogQ2FuIG9ubHkgcmVzdW1lIGF1dG9tYXRpY2FsbHkgaWYgdGhleSBhcmUgbm90IHlldCBpZGxlLlxuICAgKi9cbiAgbm90SWRsZVxufVxuXG4vKipcbiAqIEEgc2VydmljZSBmb3IgZGV0ZWN0aW5nIGFuZCByZXNwb25kaW5nIHRvIHVzZXIgaWRsZW5lc3MuXG4gKi9cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBJZGxlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgcHJpdmF0ZSBpZGxlOiBudW1iZXIgPSAyMCAqIDYwOyAvLyBpbiBzZWNvbmRzXG4gIHByaXZhdGUgdGltZW91dFZhbCA9IDMwOyAvLyBpbiBzZWNvbmRzXG4gIHByaXZhdGUgYXV0b1Jlc3VtZTogQXV0b1Jlc3VtZSA9IEF1dG9SZXN1bWUuaWRsZTtcbiAgcHJpdmF0ZSBpbnRlcnJ1cHRzOiBBcnJheTxJbnRlcnJ1cHQ+ID0gbmV3IEFycmF5KCk7XG4gIHByaXZhdGUgcnVubmluZyA9IGZhbHNlO1xuICBwcml2YXRlIGlkbGluZzogYm9vbGVhbjtcbiAgcHJpdmF0ZSBpZGxlSGFuZGxlOiBhbnk7XG4gIHByaXZhdGUgdGltZW91dEhhbmRsZTogYW55O1xuICBwcml2YXRlIGNvdW50ZG93bjogbnVtYmVyO1xuICBwcml2YXRlIGtlZXBhbGl2ZUVuYWJsZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSBrZWVwYWxpdmVTdmM6IEtlZXBhbGl2ZVN2YztcblxuICBwdWJsaWMgb25JZGxlU3RhcnQ6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcigpO1xuICBwdWJsaWMgb25JZGxlRW5kOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgcHVibGljIG9uVGltZW91dFdhcm5pbmc6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gIHB1YmxpYyBvblRpbWVvdXQ6IEV2ZW50RW1pdHRlcjxudW1iZXI+ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XG4gIHB1YmxpYyBvbkludGVycnVwdDogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgW2tleTogc3RyaW5nXTogYW55O1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgZXhwaXJ5OiBJZGxlRXhwaXJ5LFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIEBPcHRpb25hbCgpIGtlZXBhbGl2ZVN2Yz86IEtlZXBhbGl2ZVN2YyxcbiAgICBAT3B0aW9uYWwoKSBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ/OiBPYmplY3RcbiAgKSB7XG4gICAgaWYgKGtlZXBhbGl2ZVN2Yykge1xuICAgICAgdGhpcy5rZWVwYWxpdmVTdmMgPSBrZWVwYWxpdmVTdmM7XG4gICAgICB0aGlzLmtlZXBhbGl2ZUVuYWJsZWQgPSB0cnVlO1xuICAgIH1cbiAgICB0aGlzLnNldElkbGluZyhmYWxzZSk7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIHRoZSBpZGxlIG5hbWUgZm9yIGxvY2FsU3RvcmFnZS5cbiAgICogSW1wb3J0YW50IHRvIHNldCBpZiBtdWx0aXBsZSBpbnN0YW5jZXMgb2YgSWRsZSB3aXRoIExvY2FsU3RvcmFnZUV4cGlyeVxuICAgKiBAcGFyYW0gVGhlIG5hbWUgb2YgdGhlIGlkbGUuXG4gICAqL1xuICBzZXRJZGxlTmFtZShrZXk6IHN0cmluZyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmV4cGlyeSBpbnN0YW5jZW9mIExvY2FsU3RvcmFnZUV4cGlyeSkge1xuICAgICAgdGhpcy5leHBpcnkuc2V0SWRsZU5hbWUoa2V5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAnQ2Fubm90IHNldCBleHBpcnkga2V5IG5hbWUgYmVjYXVzZSBubyBMb2NhbFN0b3JhZ2VFeHBpcnkgaGFzIGJlZW4gcHJvdmlkZWQuJ1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHdoZXRoZXIgb3Igbm90IGtlZXBhbGl2ZSBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkLlxuICAgKiBAcmV0dXJuIFRydWUgaWYgaW50ZWdyYXRpb24gaXMgZW5hYmxlZDsgb3RoZXJ3aXNlLCBmYWxzZS5cbiAgICovXG4gIGdldEtlZXBhbGl2ZUVuYWJsZWQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMua2VlcGFsaXZlRW5hYmxlZDtcbiAgfVxuXG4gIC8qXG4gICAqIFNldHMgYW5kIHJldHVybnMgd2hldGhlciBvciBub3Qga2VlcGFsaXZlIGludGVncmF0aW9uIGlzIGVuYWJsZWQuXG4gICAqIEBwYXJhbSBUcnVlIGlmIHRoZSBpbnRlZ3JhdGlvbiBpcyBlbmFibGVkOyBvdGhlcndpc2UsIGZhbHNlLlxuICAgKiBAcmV0dXJuIFRoZSBjdXJyZW50IHZhbHVlLlxuICAgKi9cbiAgc2V0S2VlcGFsaXZlRW5hYmxlZCh2YWx1ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5rZWVwYWxpdmVTdmMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgJ0Nhbm5vdCBlbmFibGUga2VlcGFsaXZlIGludGVncmF0aW9uIGJlY2F1c2Ugbm8gS2VlcGFsaXZlU3ZjIGhhcyBiZWVuIHByb3ZpZGVkLidcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuICh0aGlzLmtlZXBhbGl2ZUVuYWJsZWQgPSB2YWx1ZSk7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IHRpbWVvdXQgdmFsdWUuXG4gICAqIEByZXR1cm4gVGhlIHRpbWVvdXQgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIGdldFRpbWVvdXQoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy50aW1lb3V0VmFsO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyB0aGUgdGltZW91dCB2YWx1ZS5cbiAgICogQHBhcmFtIHNlY29uZHMgLSBUaGUgdGltZW91dCB2YWx1ZSBpbiBzZWNvbmRzLiAwIG9yIGZhbHNlIHRvIGRpc2FibGUgdGltZW91dCBmZWF0dXJlLlxuICAgKiBAcmV0dXJuIFRoZSBjdXJyZW50IHZhbHVlLiBJZiBkaXNhYmxlZCwgdGhlIHZhbHVlIHdpbGwgYmUgMC5cbiAgICovXG4gIHNldFRpbWVvdXQoc2Vjb25kczogbnVtYmVyIHwgYm9vbGVhbik6IG51bWJlciB7XG4gICAgaWYgKHNlY29uZHMgPT09IGZhbHNlKSB7XG4gICAgICB0aGlzLnRpbWVvdXRWYWwgPSAwO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHNlY29uZHMgPT09ICdudW1iZXInICYmIHNlY29uZHMgPj0gMCkge1xuICAgICAgdGhpcy50aW1lb3V0VmFsID0gc2Vjb25kcztcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiJ3NlY29uZHMnIGNhbiBvbmx5IGJlICdmYWxzZScgb3IgYSBwb3NpdGl2ZSBudW1iZXIuXCIpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLnRpbWVvdXRWYWw7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGlkbGUgdmFsdWUuXG4gICAqIEByZXR1cm4gVGhlIGlkbGUgdmFsdWUgaW4gc2Vjb25kcy5cbiAgICovXG4gIGdldElkbGUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5pZGxlO1xuICB9XG5cbiAgLypcbiAgICogU2V0cyB0aGUgaWRsZSB2YWx1ZS5cbiAgICogQHBhcmFtIHNlY29uZHMgLSBUaGUgaWRsZSB2YWx1ZSBpbiBzZWNvbmRzLlxuICAgKiBAcmV0dXJuIFRoZSBpZGxlIHZhbHVlIGluIHNlY29uZHMuXG4gICAqL1xuICBzZXRJZGxlKHNlY29uZHM6IG51bWJlcik6IG51bWJlciB7XG4gICAgaWYgKHNlY29uZHMgPD0gMCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiJ3NlY29uZHMnIG11c3QgYmUgZ3JlYXRlciB6ZXJvXCIpO1xuICAgIH1cblxuICAgIHJldHVybiAodGhpcy5pZGxlID0gc2Vjb25kcyk7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGF1dG9yZXN1bWUgdmFsdWUuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgdmFsdWUuXG4gICAqL1xuICBnZXRBdXRvUmVzdW1lKCk6IEF1dG9SZXN1bWUge1xuICAgIHJldHVybiB0aGlzLmF1dG9SZXN1bWU7XG4gIH1cblxuICBzZXRBdXRvUmVzdW1lKHZhbHVlOiBBdXRvUmVzdW1lKTogQXV0b1Jlc3VtZSB7XG4gICAgcmV0dXJuICh0aGlzLmF1dG9SZXN1bWUgPSB2YWx1ZSk7XG4gIH1cblxuICAvKlxuICAgKiBTZXRzIGludGVycnVwdHMgZnJvbSB0aGUgc3BlY2lmaWVkIHNvdXJjZXMuXG4gICAqIEBwYXJhbSBzb3VyY2VzIC0gSW50ZXJydXB0IHNvdXJjZXMuXG4gICAqIEByZXR1cm4gVGhlIHJlc3VsdGluZyBpbnRlcnJ1cHRzLlxuICAgKi9cbiAgc2V0SW50ZXJydXB0cyhzb3VyY2VzOiBBcnJheTxJbnRlcnJ1cHRTb3VyY2U+KTogQXJyYXk8SW50ZXJydXB0PiB7XG4gICAgdGhpcy5jbGVhckludGVycnVwdHMoKTtcblxuICAgIGNvbnN0IHNlbGYgPSB0aGlzO1xuXG4gICAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc291cmNlcykge1xuICAgICAgY29uc3Qgb3B0aW9ucyA9IHsgcGxhdGZvcm1JZDogdGhpcy5wbGF0Zm9ybUlkIH07XG4gICAgICBjb25zdCBzdWIgPSBuZXcgSW50ZXJydXB0KHNvdXJjZSwgb3B0aW9ucyk7XG4gICAgICBzdWIuc3Vic2NyaWJlKChhcmdzOiBJbnRlcnJ1cHRBcmdzKSA9PiB7XG4gICAgICAgIHNlbGYuaW50ZXJydXB0KGFyZ3MuZm9yY2UsIGFyZ3MuaW5uZXJBcmdzKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLmludGVycnVwdHMucHVzaChzdWIpO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmludGVycnVwdHM7XG4gIH1cblxuICAvKlxuICAgKiBSZXR1cm5zIHRoZSBjdXJyZW50IGludGVycnVwdHMuXG4gICAqIEByZXR1cm4gVGhlIGN1cnJlbnQgaW50ZXJydXB0cy5cbiAgICovXG4gIGdldEludGVycnVwdHMoKTogQXJyYXk8SW50ZXJydXB0PiB7XG4gICAgcmV0dXJuIHRoaXMuaW50ZXJydXB0cztcbiAgfVxuXG4gIC8qXG4gICAqIFBhdXNlcywgdW5zdWJzY3JpYmVzLCBhbmQgY2xlYXJzIHRoZSBjdXJyZW50IGludGVycnVwdCBzdWJzY3JpcHRpb25zLlxuICAgKi9cbiAgY2xlYXJJbnRlcnJ1cHRzKCk6IHZvaWQge1xuICAgIGZvciAoY29uc3Qgc3ViIG9mIHRoaXMuaW50ZXJydXB0cykge1xuICAgICAgc3ViLnBhdXNlKCk7XG4gICAgICBzdWIudW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICB0aGlzLmludGVycnVwdHMubGVuZ3RoID0gMDtcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgd2hldGhlciBvciBub3QgdGhlIHNlcnZpY2UgaXMgcnVubmluZyBpLmUuIHdhdGNoaW5nIGZvciBpZGxlbmVzcy5cbiAgICogQHJldHVybiBUcnVlIGlmIHNlcnZpY2UgaXMgd2F0Y2hpbmc7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqL1xuICBpc1J1bm5pbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMucnVubmluZztcbiAgfVxuXG4gIC8qXG4gICAqIFJldHVybnMgd2hldGhlciBvciBub3QgdGhlIHVzZXIgaXMgY29uc2lkZXJlZCBpZGxlLlxuICAgKiBAcmV0dXJuIFRydWUgaWYgdGhlIHVzZXIgaXMgaW4gdGhlIGlkbGUgc3RhdGU7IG90aGVyd2lzZSwgZmFsc2UuXG4gICAqL1xuICBpc0lkbGluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5pZGxpbmc7XG4gIH1cblxuICAvKlxuICAgKiBTdGFydHMgd2F0Y2hpbmcgZm9yIGluYWN0aXZpdHkuXG4gICAqL1xuICB3YXRjaChza2lwRXhwaXJ5PzogYm9vbGVhbik6IHZvaWQge1xuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG5cbiAgICBjb25zdCB0aW1lb3V0ID0gIXRoaXMudGltZW91dFZhbCA/IDAgOiB0aGlzLnRpbWVvdXRWYWw7XG4gICAgaWYgKCFza2lwRXhwaXJ5KSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IG5ldyBEYXRlKFxuICAgICAgICB0aGlzLmV4cGlyeS5ub3coKS5nZXRUaW1lKCkgKyAodGhpcy5pZGxlICsgdGltZW91dCkgKiAxMDAwXG4gICAgICApO1xuICAgICAgdGhpcy5leHBpcnkubGFzdCh2YWx1ZSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaWRsaW5nKSB7XG4gICAgICB0aGlzLnRvZ2dsZVN0YXRlKCk7XG4gICAgfVxuICAgIGlmICghdGhpcy5ydW5uaW5nKSB7XG4gICAgICB0aGlzLnN0YXJ0S2VlcGFsaXZlKCk7XG4gICAgICB0aGlzLnRvZ2dsZUludGVycnVwdHModHJ1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5ydW5uaW5nID0gdHJ1ZTtcblxuICAgIGNvbnN0IHdhdGNoRm4gPSAoKSA9PiB7XG4gICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgY29uc3QgZGlmZiA9IHRoaXMuZ2V0RXhwaXJ5RGlmZih0aW1lb3V0KTtcbiAgICAgICAgaWYgKGRpZmYgPiAwKSB7XG4gICAgICAgICAgdGhpcy5zYWZlQ2xlYXJJbnRlcnZhbCgnaWRsZUhhbmRsZScpO1xuICAgICAgICAgIHRoaXMuc2V0SWRsZUludGVydmFsT3V0c2lkZU9mWm9uZSh3YXRjaEZuLCAxMDAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLnRvZ2dsZVN0YXRlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICB0aGlzLnNldElkbGVJbnRlcnZhbE91dHNpZGVPZlpvbmUod2F0Y2hGbiwgMTAwMCk7XG4gIH1cblxuICAvKlxuICAgKiBBbGxvd3MgcHJvdHJhY3RvciB0ZXN0cyB0byBjYWxsIHdhaXRGb3JBbmd1bGFyIHdpdGhvdXQgaGFuZ2luZ1xuICAgKi9cbiAgc2V0SWRsZUludGVydmFsT3V0c2lkZU9mWm9uZSh3YXRjaEZuOiAoKSA9PiB2b2lkLCBmcmVxdWVuY3k6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICB0aGlzLmlkbGVIYW5kbGUgPSBzZXRJbnRlcnZhbCh3YXRjaEZuLCBmcmVxdWVuY3kpO1xuICAgIH0pO1xuICB9XG5cbiAgLypcbiAgICogU3RvcHMgd2F0Y2hpbmcgZm9yIGluYWN0aXZpdHkuXG4gICAqL1xuICBzdG9wKCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcEtlZXBhbGl2ZSgpO1xuXG4gICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKGZhbHNlKTtcblxuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG5cbiAgICB0aGlzLnNldElkbGluZyhmYWxzZSk7XG4gICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG5cbiAgICB0aGlzLmV4cGlyeS5sYXN0KG51bGwpO1xuICB9XG5cbiAgLypcbiAgICogRm9yY2VzIGEgdGltZW91dCBldmVudCBhbmQgc3RhdGUuXG4gICAqL1xuICB0aW1lb3V0KCk6IHZvaWQge1xuICAgIHRoaXMuc3RvcEtlZXBhbGl2ZSgpO1xuXG4gICAgdGhpcy50b2dnbGVJbnRlcnJ1cHRzKGZhbHNlKTtcblxuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG5cbiAgICB0aGlzLnNldElkbGluZyh0cnVlKTtcbiAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcbiAgICB0aGlzLmNvdW50ZG93biA9IDA7XG5cbiAgICB0aGlzLm9uVGltZW91dC5lbWl0KG51bGwpO1xuICB9XG5cbiAgLypcbiAgICogU2lnbmFscyB0aGF0IHVzZXIgYWN0aXZpdHkgaGFzIG9jY3VycmVkLlxuICAgKiBAcGFyYW0gZm9yY2UgLSBGb3JjZXMgd2F0Y2ggdG8gYmUgY2FsbGVkLCB1bmxlc3MgdGhleSBhcmUgdGltZWQgb3V0LlxuICAgKiBAcGFyYW0gZXZlbnRBcmdzIC0gT3B0aW9uYWwgc291cmNlIGV2ZW50IGFyZ3VtZW50cy5cbiAgICovXG4gIGludGVycnVwdChmb3JjZT86IGJvb2xlYW4sIGV2ZW50QXJncz86IGFueSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5ydW5uaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMudGltZW91dFZhbCAmJiB0aGlzLmV4cGlyeS5pc0V4cGlyZWQoKSkge1xuICAgICAgdGhpcy50aW1lb3V0KCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMub25JbnRlcnJ1cHQuZW1pdChldmVudEFyZ3MpO1xuXG4gICAgaWYgKFxuICAgICAgZm9yY2UgPT09IHRydWUgfHxcbiAgICAgIHRoaXMuYXV0b1Jlc3VtZSA9PT0gQXV0b1Jlc3VtZS5pZGxlIHx8XG4gICAgICAodGhpcy5hdXRvUmVzdW1lID09PSBBdXRvUmVzdW1lLm5vdElkbGUgJiYgIXRoaXMuZXhwaXJ5LmlkbGluZygpKVxuICAgICkge1xuICAgICAgdGhpcy53YXRjaChmb3JjZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRJZGxpbmcodmFsdWU6IGJvb2xlYW4pOiB2b2lkIHtcbiAgICB0aGlzLmlkbGluZyA9IHZhbHVlO1xuICAgIHRoaXMuZXhwaXJ5LmlkbGluZyh2YWx1ZSk7XG4gIH1cblxuICBwcml2YXRlIHRvZ2dsZVN0YXRlKCk6IHZvaWQge1xuICAgIHRoaXMuc2V0SWRsaW5nKCF0aGlzLmlkbGluZyk7XG5cbiAgICBpZiAodGhpcy5pZGxpbmcpIHtcbiAgICAgIHRoaXMub25JZGxlU3RhcnQuZW1pdChudWxsKTtcbiAgICAgIHRoaXMuc3RvcEtlZXBhbGl2ZSgpO1xuXG4gICAgICBpZiAodGhpcy50aW1lb3V0VmFsID4gMCkge1xuICAgICAgICB0aGlzLmNvdW50ZG93biA9IHRoaXMudGltZW91dFZhbDtcbiAgICAgICAgdGhpcy5kb0NvdW50ZG93bigpO1xuICAgICAgICB0aGlzLnNldFRpbWVvdXRJbnRlcnZhbE91dHNpZGVab25lKCgpID0+IHtcbiAgICAgICAgICB0aGlzLmRvQ291bnRkb3duSW5ab25lKCk7XG4gICAgICAgIH0sIDEwMDApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRvZ2dsZUludGVycnVwdHModHJ1ZSk7XG4gICAgICB0aGlzLm9uSWRsZUVuZC5lbWl0KG51bGwpO1xuICAgICAgdGhpcy5zdGFydEtlZXBhbGl2ZSgpO1xuICAgIH1cblxuICAgIHRoaXMuc2FmZUNsZWFySW50ZXJ2YWwoJ2lkbGVIYW5kbGUnKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0VGltZW91dEludGVydmFsT3V0c2lkZVpvbmUoXG4gICAgaW50ZXJ2YWxGbjogKCkgPT4gdm9pZCxcbiAgICBmcmVxdWVuY3k6IG51bWJlclxuICApIHtcbiAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgdGhpcy50aW1lb3V0SGFuZGxlID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICBpbnRlcnZhbEZuKCk7XG4gICAgICB9LCBmcmVxdWVuY3kpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB0b2dnbGVJbnRlcnJ1cHRzKHJlc3VtZTogYm9vbGVhbik6IHZvaWQge1xuICAgIGZvciAoY29uc3QgaW50ZXJydXB0IG9mIHRoaXMuaW50ZXJydXB0cykge1xuICAgICAgaWYgKHJlc3VtZSkge1xuICAgICAgICBpbnRlcnJ1cHQucmVzdW1lKCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpbnRlcnJ1cHQucGF1c2UoKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEV4cGlyeURpZmYodGltZW91dDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBjb25zdCBub3c6IERhdGUgPSB0aGlzLmV4cGlyeS5ub3coKTtcbiAgICBjb25zdCBsYXN0OiBEYXRlID0gdGhpcy5leHBpcnkubGFzdCgpIHx8IG5vdztcbiAgICByZXR1cm4gbGFzdC5nZXRUaW1lKCkgLSBub3cuZ2V0VGltZSgpIC0gdGltZW91dCAqIDEwMDA7XG4gIH1cblxuICBwcml2YXRlIGRvQ291bnRkb3duSW5ab25lKCk6IHZvaWQge1xuICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgdGhpcy5kb0NvdW50ZG93bigpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkb0NvdW50ZG93bigpOiB2b2lkIHtcbiAgICBjb25zdCBkaWZmID0gdGhpcy5nZXRFeHBpcnlEaWZmKHRoaXMudGltZW91dFZhbCk7XG4gICAgaWYgKGRpZmYgPiAwKSB7XG4gICAgICB0aGlzLnNhZmVDbGVhckludGVydmFsKCd0aW1lb3V0SGFuZGxlJyk7XG4gICAgICB0aGlzLmludGVycnVwdCh0cnVlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaWRsaW5nKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY291bnRkb3duIDw9IDApIHtcbiAgICAgIHRoaXMudGltZW91dCgpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMub25UaW1lb3V0V2FybmluZy5lbWl0KHRoaXMuY291bnRkb3duKTtcblxuICAgIGNvbnN0IGNvdW50ZG93bk1zID0gKCh0aGlzLnRpbWVvdXRWYWwgLSAxKSAqIDEwMDApICsgZGlmZjtcbiAgICB0aGlzLmNvdW50ZG93biA9IE1hdGgucm91bmQoY291bnRkb3duTXMgLyAxMDAwKTtcbiAgfVxuXG4gIHByaXZhdGUgc2FmZUNsZWFySW50ZXJ2YWwoaGFuZGxlTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgaGFuZGxlID0gdGhpc1toYW5kbGVOYW1lXTtcbiAgICBpZiAoaGFuZGxlICE9PSBudWxsICYmIHR5cGVvZiBoYW5kbGUgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXNbaGFuZGxlTmFtZV0pO1xuICAgICAgdGhpc1toYW5kbGVOYW1lXSA9IG51bGw7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzdGFydEtlZXBhbGl2ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMua2VlcGFsaXZlU3ZjIHx8ICF0aGlzLmtlZXBhbGl2ZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICB0aGlzLmtlZXBhbGl2ZVN2Yy5waW5nKCk7XG4gICAgfVxuXG4gICAgdGhpcy5rZWVwYWxpdmVTdmMuc3RhcnQoKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RvcEtlZXBhbGl2ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMua2VlcGFsaXZlU3ZjIHx8ICF0aGlzLmtlZXBhbGl2ZUVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmtlZXBhbGl2ZVN2Yy5zdG9wKCk7XG4gIH1cblxuICAvKlxuICAgKiBDYWxsZWQgYnkgQW5ndWxhciB3aGVuIGRlc3Ryb3lpbmcgdGhlIGluc3RhbmNlLlxuICAgKi9cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdG9wKCk7XG4gICAgdGhpcy5jbGVhckludGVycnVwdHMoKTtcbiAgfVxufVxuIl19